<html>
<head>
  <title>PgTAP Database Unit Testing (PgConfEU 2014)</title>
  <link rel="stylesheet" type="text/css" href="talk.css"/>

   <script type="text/javascript" src="jquery/jquery.min.js"></script>
   <script type="text/javascript" src="jquery/jquery-ui.min.js"></script>
   <script type="text/javascript" src="jquery/jquery.fullPage.js"></script>

  <script type="text/javascript">
  $(document).ready(function() {
      $('#container').fullpage();
  });
</script>

</head>
<body>

<div id="container">

<div class='section'>
<h1>Database Unit Testing with PGTap</h1>
<h3>how to test the living sh*** out of your database</h3>
<a href="https://github.com/Su-Shee/talks">slides and code on github</a>
</div>

<div class='section'>
<h1>about me</h1>
<p>political scientist by education so I have a thing for "data"</p>
<p>one of those self-tought web &amp; linux people since '94</p>
<p>mostly does perl, javascript, postgres, R and some shell</p>
<p>writes "health applications" (enterprise in disguise) during the day</p>
<p>does some writing for (german) tech magazines here and there</p>
</div>

<div class='section'>
<h1>testing</h1>
<h3>we're all doing it, right? RIGHT?</h3>
<p>we test the top - UIs with e.g. Selenium, PhanthomJS</p>
<p>we test in the middle with whatever we have</p>
<p>but: do we test down below?</p>
<p>so anybody? Epic? PgUnit?</p>
</div>

<div class='section'>
<h1>database testing</h1>
<h3>well. a little</h3>
<h3>we might have an ORM in play</h3>
<p>we maybe write tests via DBIx::Class (Perl)</p>
<p>... or ActiveRecord/DataMapper/Sequel (Ruby)..</p>
<p>... or SQLAlchemy/Django (Python)...</p>
<p>... Hibernate and 3842 others (Java)...</p>
</div>

<div class='section'>

<h1>database testing</h1>
<h3>or we don't have an ORM..</h3>
<p>and do some testing via DBI (Perl)...</p>
<p>... or PsycoPg (Python)</p>
<p>... Ruby has a DBI too..</p>
<p>... there's Java's JDBC "plain"...</p>
<p>well, any language has some DB interface one way or another</p>
</div>

<div class='section'>

<h1>database testing</h1>
<h3>so what if we could test the DB alone and nothing on top?</h3>
<p>not tied to specific programming language</p>
<p>independent of the DBI or ORM used on top</p>
<p>just run tests with the database and nothing else required</p>
<p>just you, and your database, alone.. ;)</p>
</div>

<div class='section'>

<h1>and my test strategy?</h1>
<h3>does NOT matter</h3>
<p>whether you prefer a pristine setup and tear down</p>
<p>or rather a database dump filled with messy real world data</p>
<p>both perfectly fine!</p>
</div>

<div class='section'>
<h1>so what IS PgTAP?!</h1>
<p>
"pgTAP is a unit testing framework for PostgreSQL written in PL/pgSQL and
PL/SQL. It includes a comprehensive collection of TAP-emitting assertion
functions, as well as the ability to integrate with other TAP-emitting test
frameworks. It can also be used in the xUnit testing style."
</p>
<p>
meaning: you can write tests (ORLY?) and its output works in your
Jenkins/BuildBot/YouNameIt CD/CI thing
</p>
<p>written by David "theory" Wheeler <a href="http://pgtap.org/">see
here</a></p>
<p>also available as <a href="http://theory.github.io/mytap/">myTAP for MySQL</a> No Postgres envy! :)</p>
<p>btw: for DB change management: theory's <a href="http://sqitch.org/">Sqitch</a>
</div>

<div class='section'>
<h1>PgTAP how to</h1>
<h3>... it's really complicated</h3>
<p>download from <a href="http://pgxn.org/dist/pgtap/">PGXN</a></p>
<p>configure, make installcheck, make install</p>
<p>create extension pgtap;</p>
<p>that was it.</p>
<p>the database has now testing*</p>
<p>*there's of course more options - see extensive docs!</p>
</div>

<div class='section'>
<h1>what is your database?</h1>
<h3>a short reminder what we have</h3>
<p>databases, schemas, configuration</p>
<p>roles, groups</p>
<p>tables and columns of course</p>
<p>types, checks, constraints</p>
<p>indexes, sequences,</p>
<h3>and, of course actually doing stuff with your data:</h3>
<p>views, triggers, functions</p>
<p>selects, inserts, updates, deletes, alters</p>
</div>

<div class='section'>
<h1>gimme a test already!</h1>
<h3>something super simple you can do at home</h3>
<h3>you have somewhere:</h3>
<pre>
<span class="line">CREATE TABLE cats ();</span>
<span class="line">CREATE TABLE traits ();</span>
</pre>
<h3>and, do you really?</h3>
<pre>
<span class="line">BEGIN;</span>
<span class="line">SELECT plan(3);</span>
<span class="line">SELECT has_table('cats');</span>
<span class="line">SELECT has_table('traits');</span>
<span class="line">SELECT tables_are('public', ARRAY['cats', 'traits']);</span>
<span class="line">SELECT * FROM finish();</span>
<span class="line">ROLLBACK;</span>
</pre>
<p>I first thought this is too boring, testing if a table is "there" - but then.. join on a million tables.. interesting test, for sure. :)</p>
</div>

<div class='section'>
<h1>utmost basic tests: existence</h1>
<h3>to get a feeling, just check if you actually have everything</h3>
<pre>
<span class="line">BEGIN;</span>
<span class="line">SELECT plan(3);</span>
<span class="line">SELECT has_table('cats');</span>
<span class="line">SELECT has_pk('cats');</span>
<span class="line">SELECT has_index('cats', 'cats_);</span>
<span class="line">SELECT has_check('cats');</span>
<span class="line">SELECT has_column('cats', 'id');</span>
<span class="line">SELECT * FROM finish();</span>
<span class="line">ROLLBACK;</span>
</pre>
</div>

<div class='section'>
<h1>... more things which should exist..</h1>
<h3>almost everything has a test for existence</h3>
<pre>
<span class="line">SELECT has_sequence('public', 'cats_id_seq',</span>
<span class="line"> 'Column type serial therefore has a sequence');</span>
<span class="line">SELECT has_function('nicer_age');</span>
<span class="line">SELECT has_trigger('traits', 'updated');</span>
<span class="line">SELECT has_index('cats', 'cats_pkey');</span>
<span class="line">SELECT has_role('catsitter');</span>
</pre>
</div>

<div class='section'>
<h1>really, a lot of tests</h1>

<span class="thingie">has_tablespace()</span>
<span class="thingie">has_schema()</span>
<span class="thingie">has_relation()</span>
<span class="thingie">has_table()</span>
<span class="thingie">has_view()</span>
<span class="thingie">has_sequence()</span>
<span class="thingie">has_foreign_table()</span>
<span class="thingie">has_type()</span>
<span class="thingie">has_composite()</span>
<span class="thingie">has_domain()</span>
<span class="thingie">has_enum()</span>
<span class="thingie">has_index()</span>
<span class="thingie">has_trigger()</span>
<span class="thingie">has_rule()</span>
<span class="thingie">has_function()</span>
<span class="thingie">has_cast()</span>
<span class="thingie">has_operator()</span>
<span class="thingie">has_rightop()</span>
<span class="thingie">has_opclass()</span>
<span class="thingie">has_role()</span>
<span class="thingie">has_user()</span>
<span class="thingie">has_group()</span>
<span class="thingie">has_language()</span>
<span class="thingie">has_column()</span>
<span class="thingie">col_has_default()</span>
<span class="thingie">has_pk()</span>
<span class="thingie">has_fk()</span>
<span class="thingie">has_unique()</span>
<span class="thingie">has_check()</span>
<span class="thingie">col_has_check()</span>
</div>

<div class='section'>
<h1>yes! foo_hasnt exists too!</h1>
<h3>all tests like this have their "should NOT exist" equivalent</h3>
</div>

<div class='section'>
<h1></h1>
<h3></h3>
</div>

<div class='section'>
<h1>Thank You Very Much!</h1>
<h3>and that's how catpics are REALLY made</h3>
<img src="cat-surrounded-by-paparazzi.jpeg"/>
</br>
</br>
<a href="https://github.com/Su-Shee/talks">slides and code on github</a>
</div>
</div>
</body>
</html>


